<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>go-http-streamer</title>
    <style>
      body {
        background-color: #1c1815;
      }
      #logo {
        width: 200px;
        position: fixed;
        right: 0px;
        bottom: 0px;
      }
    </style>
  </head>
  <body>
    <canvas id="funnel"></canvas>
    <img id="logo" src="Tailscale-Logo-White.png" />
  </body>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.12.0/matter.min.js"></script>
  <script>
    /**
     * All credit to https://github.com/shayne for the animation code.
     */
    const world = document.getElementById("funnel");
    const { Engine, Render, Runner, World, Bodies } = Matter;

    let engine = Engine.create();

    const textures = [
      "https://user-images.githubusercontent.com/79330/224512133-beadac7e-2e05-402f-adf4-d439a95324a9.png",
      "https://user-images.githubusercontent.com/79330/224512134-4d979eb1-b940-4781-81f9-3e279da48018.png",
    ];
    function init() {
      let width = $(window).width();
      let height = $(window).height();

      engine.events = {};
      World.clear(engine.world);
      Engine.clear(engine);
      engine = Engine.create();
      engine.timing.timeScale = 0.9;

      let render = Render.create({
        canvas: world,
        engine: engine,
        options: {
          wireframes: false,
          background: "transparent",
          width: width,
          height: height,
        },
      });

      World.add(engine.world, [
        Bodies.rectangle(270, 0, 1030, 20, {
          isStatic: true,
          angle: Math.PI * 0.3,
          render: { fillStyle: "#060a1900" },
        }),
        Bodies.rectangle(1060, 0, 1030, 20, {
          isStatic: true,
          angle: -Math.PI * 0.3,
          render: { fillStyle: "#060a1900" },
        }),
        Bodies.rectangle(580, 780, 20, 700, {
          isStatic: true,
          angle: Math.PI * 0,
          render: { fillStyle: "#060a1900" },
        }),
        Bodies.rectangle(750, 780, 20, 700, {
          isStatic: true,
          angle: Math.PI * 0,
          render: { fillStyle: "#060a1900" },
        }),
      ]);

      function createBall() {
        const ORIGINAL_SIZE = 120;
        // const SIZE = Math.floor(Math.random() * 76) + 30;
        const SIZE = 100;
        const minX = 300;
        const maxX = 900;
        const ball = Bodies.circle(
          minX + Math.round(Math.random() * (maxX - minX)),
          -30,
          40,
          {
            friction: 0.001,
            frictionAir: 0.025,
            restitution: 0.5,
            density: 0.001,
            render: {
              sprite: {
                texture: textures[Math.floor(Math.random() * textures.length)],
                xScale: SIZE / ORIGINAL_SIZE,
                yScale: SIZE / ORIGINAL_SIZE,
              },
            },
          }
        );

        setTimeout(() => {
          World.remove(engine.world, ball);
        }, 20000);

        return ball;
      }

      Engine.run(engine);

      Render.run(render);

      const handleClick = () => {
        const xhr = new XMLHttpRequest();
        xhr.timeout = 1000;

        xhr.onload = () => {
          if (xhr.readyState === xhr.DONE && xhr.status === 200) {
            World.add(engine.world, [createBall()]);
          }
        };

        errFn = () => {
          console.log("error from backend");
        };
        xhr.onabort = errFn;
        xhr.onerror = errFn;
        xhr.ontimeout = errFn;

        xhr.open("GET", "/api/uuid");
        xhr.send();
      };

      setInterval(handleClick, 155);
    }

    init();
  </script>
</html>
